Безопасность сайтов — тема, о которой редко говорят с новичками. При этом от нее зависит судьба любого бизнеса. Проблемы с безопасностью могут привести к утечке данных пользователей и даже к полному уничтожению сайта.

Исследования показывают, что у подавляющего большинства сайтов есть проблемы с безопасностью, и они подвержены атакам. И иногда случаются громкие взломы и утечки данных сотен тысяч и миллионов пользователей.

В этом уроке поговорим о том, как не стоит поступать, чтобы злоумышленники не получили данные пользователей, и как обезопасить свой сайт от атак. Об этой теме нужно говорить как можно раньше, что позволит избежать фатальных ошибок.

## Защищаем сайт от атак

Чтобы сайты были защищены, нужно соблюдать первое главное правило безопасности — никогда не доверяйте пользователям. В первую очередь это правило касается данных, которые они вводят.

Представим, что нам нужно вывести имя пользователя, взятое из адреса: _/users/nick_. Код, который реализует эту функциональность, рассчитывает на то, что в адресе используются только допустимые имена. Но что произойдет, если попытаться открыть такой адрес:

```
# Вот, что может произойти, если доверять данным,
# которые ввел пользователь, и не обрабатывать их:
http://localhost:5000/users/%3Cscript%3Ealert('attack!')%3B%3C%2Fscript%3E
```

![[Pasted image 20230220175728.png]]

В этом адресе [закодирован](https://ru.wikipedia.org/wiki/URL#%D0%9A%D0%BE%D0%B4%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_URL) код на JavaScript, который в оригинале выглядит так:

```
<script>
  alert('attack!');
</script>
```

Проблема в том, что этот код не отобразился, а был вставлен в HTML как его часть и выполнился. Для браузера такой JS выглядит как часть страницы. Если попробовать открыть получившийся HTML, то он будет выглядеть так:

```
<h1><script>alert('attack!');</script></h1>
```

Совсем не то, что мы ожидали. Такая атака называется [XSS или «межсайтовый скриптинг»](https://ru.wikipedia.org/wiki/%D0%9C%D0%B5%D0%B6%D1%81%D0%B0%D0%B9%D1%82%D0%BE%D0%B2%D1%8B%D0%B9_%D1%81%D0%BA%D1%80%D0%B8%D0%BF%D1%82%D0%B8%D0%BD%D0%B3). Она работает так:

1.  На страницу внедряется вредоносный код, который выполняется в браузере пользователя
2.  Этот код отправляет информацию о пользователе на сервер злоумышленника

Специфика подобных атак заключается в том, что вредоносный код может использовать авторизацию пользователя в веб-системе. Так он получает к ней расширенный доступ или авторизационные данные пользователя. XSS относится к одному из самых распространенных типов атак из-за большого количества уязвимостей даже на сайтах больших и серьезных компаний, например, Facebook.

Уязвимость возникает из-за доверия к пользовательским данным. В нашем коде вывод слага делается без предварительной обработки. Но это неправильно.

Дело в том, что браузер пытается интерпретировать как HTML всё, что похоже на него. Если в исходном коде встречается конструкция `<текст>`, то браузер автоматически считает ее тегом. Чтобы вывести данные, которые не рассматриваются как HTML, нужно использовать специализированные функции для превращения теги в [html entities](https://en.wikipedia.org/wiki/Unicode_and_HTML#Named_character_entities):

```
import html


text = "A 'quote' is <b>bold</b>"

print(html.escape(text))
# => A 'quote' is &lt;b&gt;bold&lt;/b&gt;
```

Получившаяся строка содержит безопасное описание тегов в виде html entities. Например, `&lt;` отобразится как `<`, а `&gt;` как `>`. Используемый нами шаблонизатор Jinja2 внутри Flask уже настроен на автоматическое экранирование всех значений. Поэтому, если применить простой вывод переменной:

```
<h1>{{ name}}</h1>
```

Мы получим следующий результат:

![Image processing escape](https://cdn2.hexlet.io/derivations/image/original/eyJpZCI6ImZhZjNiZGExNjJiOGYxNmY3YTgzMTZhN2Y2NWEyNGQ5LnBuZyIsInN0b3JhZ2UiOiJjYWNoZSJ9?signature=7777fa798dcb1825a88fc0c66155f3ea73270c8ab32e6b758c5d54ba2e6ea7f5)

Автоматическое экранирование помогает исключить проблемы с XSS атаками, но есть и другие места, где нужно быть осторожным:

-   Генерация HTML без помощи Jinja2
-   Обработка разметки, предоставляемой пользователем
-   Обработка HTML кода из загруженных пользователем файлов

Хоть Jinja2 и защищает от XSS, экранируя HTML, есть два вида уязвимостей, от которых Jinja2 не может защитить:

-   XSS путем внедрения в атрибуты. Чтобы защититься от таких атак, нужно заключать значения атрибутов в двойные или одинарные кавычки:

```
  <input value="{{ value }}">
```

Если этого не сделать, то злоумышленник может с легкостью внедрить JS-код на страницу, например:

```
  onclick=alert('attack!')
```

-   Атрибут `href` тега `a` может содержать `javascript:URI`, который браузер выполнит при нажатии:

```
  <a href="{{ value }}">Нажми тут</a>
  <a href="javascript:alert('attack!');">Нажми тут</a>
```

Чтобы защитить от такого вида атак, необходимо использовать заголовок ответа [Content Security Policy (CSP)](https://flask.palletsprojects.com/security/#security-csp).

Кроме XSS часто встречаются и другие виды атак, например, SQL Injection. Но чтобы их понимать, важно разобраться в принципе работы базы данных.
  
Процесс создания круда пользователя включает минимум семь маршрутов. Два из них — просмотр списка и конкретного ресурса — мы уже разобрали. В этом уроке разберем следующие два, которые относятся к созданию сущности.

## Создание сущности

Создание сущности включает в себя два действия: отображение формы и обработка данных формы. За каждое из этих действий отвечает свой маршрут. Вот несколько примеров:

**Пользователь**

-   GET `/users/new`
-   POST `/users`

**Курс**

-   GET `/courses/new`
-   POST `/courses`

**Сотрудник компании (пример вложенного маршрута)**

-   GET `/companies/3/users/new`
-   POST `/companies/3/users`
![[Pasted image 20230226141014.png]]


Разберем каждое действие подробнее.

### Отображение формы

**Обработчик**

``` python
@app.route('/schools/new')
def new_school():
    school = []
    errors = []

    return render_template(
            'schools/new.html',
            school=school,
            errors=errors,
            )
```

**Шаблон**

``` html
<form action="/schools" method="post">
    <div>
        <label>
            Название *
            <input type="text" name="name" value="{{ school.name|default('', true) }}">
        </label>
        {% if errors %}
            <div>{{ errors.name }}</div>
        {% endif %}
    </div>
    <input type="submit" value="Create">
</form>
```

Содержимое обработчика сильно зависит от того, какой используется инструментарий. Если мы применяем билдеры формы, то обработчик создает форму как объект и отправляет его в шаблон. Билдер берет на себя огромное количество задач: обрабатывает вывод ошибок, занимается валидацией и подготовкой данных.

Особо умные билдеры знают про ту сущность, с которой они работают, и могут строить формы в полностью автоматическом режиме.

В нашем примере такого нет, поэтому все действия делаются руками. Кроме данных в шаблон передается список `errors`. Это нужно, так как форма используется обоими обработчиками: одним только для отображения новой формы, другим — для отображения формы в случае наличия ошибок.

### Обработка данных формы

``` python
@app.post('/schools')
def post_school():
    repo = SchoolRepository()

    # Извлекаем данные формы
    data = request.form.to_dict()

    # Проверяем корректность данных
    errors = validate(data)
    if errors:
        # Если возникли ошибки, то устанавливаем код ответа в 422 и рендерим форму с указанием ошибок
        return render_template(
            'schools/new.html',
            school=data,
            errors=errors
            ), 422

    # Если данные корректны, то сохраняем, добавляем флеш и выполняем редирект
    repo.save(data)
    flash('School has been created', 'success')
    # Обратите внимание на использование именованного роутинга
    return redirect(url_for('schools'))
```

Своего шаблона у страниц с ошибкой при валидации нет. Если данные оказались не валидны, то этот обработчик рисует форму обработчика `new` и отправляет ее вместе с кодом ответа 422 — Unprocessable Entity. Если данные корректны, то выполняется основная логика обработчика – происходит сохранение школы в базу данных `repo.save(data)`, а затем редирект на список школ с оповещением через флеш об успешном добавлении.

На этом создание сущности заканчивается. Следующим шагом научимся ее обновлять.

---

#### Самостоятельная работа

1.  Сделайте все поля формы создания пользователя обязательными
2.  Реализуйте обработку введенных данных и рендеринг формы с выводом ошибок
![[Pasted image 20230226141045.png]]